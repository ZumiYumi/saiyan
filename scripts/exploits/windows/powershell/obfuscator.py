import sys
import random
import string
import argparse

#TODO:1 implement an option to execute the obfuscating in the terminal natively ie "./powershell_hide.py -c "command"

#container for argument specs and has options to apply to the parser as a whole
parser = argparse.ArgumentParser(
    prog='Code Execution Obfuscator',
    description='This program works by inputting the command you want to use as a CLI flag, then the program wll shuffle the command and randomize it, then CHAR it, then spit out that code in the terminal to be used by a threat actor',
    epilog='Have fun'
    )
##expand the scripts output
parser = argparse.ArgumentParser(
    '-v', "--verbose"
)

if len(sys.argv) != 2:
    sys.exit()
#    elif 




#TODO:2 research different means to hide commands

#function to obfuscate commands
def obfuscate():
    pwshCommands = input("Please enter your command to encrypt: ").strip()
    
    #split the original command into individual characters and convert them to [char]
    char_parts = [f"[char]{ord(command)}" for command in pwshCommands]
    
    var_assignments = []
    combined_parts = []
# hi <3 // hi back!!!
    start = 0
    while start < len(char_parts): #loop that counts down from length of character parts which is the ordinate of each command in pwshCommands
        length = random.randint(2, 5) #random chunk between 2 and 5
        chunk = char_parts[start:start + length]
        var_name = f"$p{len(var_assignments)}"
        var_assignments.append(f"{var_name} = {' + '.join(chunk)}")
        combined_parts.append(var_name)
        start += length

    final_combined = ' + '.join(combined_parts)

    noise_variables = [
        f"$d{idx} = '{''.join(random.choices(string.ascii_letters, k=5))}'"
        for idx in range(3) #make random junk
    ]
    obfuscated_command = (
        f"powershell -Command \"{'; '.join(var_assignments + noise_variables)}; "
        f"Invoke-Expression ({final_combined})\""
    )
    return obfuscated_command

#main
def main():
    print(obfuscate())

if __name__ == "__main__":
    main()
